# 새 분석하기 페이지 요구사항

## 페이지 개요
새 사주 분석을 생성하기 위한 입력 폼 페이지입니다. 사용자가 분석 대상의 정보를 입력하고, Gemini API를 통해 분석을 요청하며, 분석 완료 시 결과 페이지로 리다이렉트됩니다.

## 경로
- `/analysis/new`

## 접근 권한
- 로그인 필수 (Clerk 인증)
- 분석 가능 횟수가 있는 사용자만 접근 가능
  - 무료 회원: `free_analysis_count > 0`
  - Pro 회원: `monthly_analysis_count > 0`

## 주요 기능

### 1. 분석 정보 입력 폼

#### 1.1 입력 필드
1. **성함** (필수)
   - 유형: 텍스트 입력
   - 제약: 2-50자
   - 실시간 검증: 글자 수 체크
   - 에러 메시지: "성함은 2자 이상 50자 이하로 입력해주세요"

2. **생년월일** (필수)
   - 유형: 날짜 선택기 (Date Picker)
   - 제약: 1900년 이후 ~ 오늘 날짜
   - 실시간 검증: 미래 날짜 불가
   - 에러 메시지: "올바른 생년월일을 입력해주세요"

3. **출생시간** (선택)
   - 유형: 시/분 드롭다운
   - 형식: HH:mm (24시간제)
   - 범위: 00:00 ~ 23:59
   - 기본값: 미선택 (null)
   - 안내: "출생시간을 모르시면 비워두세요"

4. **성별** (필수)
   - 유형: 라디오 버튼
   - 옵션: 남성 / 여성
   - 기본값: 미선택
   - 에러 메시지: "성별을 선택해주세요"

#### 1.2 실시간 유효성 검증
- 각 필드 blur 시 개별 검증 실행
- 필수 필드 누락 시 빨간색 테두리 + 에러 메시지 표시
- 모든 필수 필드 유효 시 "분석 시작" 버튼 활성화
- 검증 통과 필드는 초록색 체크마크 표시

### 2. 남은 분석 횟수 표시

#### 2.1 표시 위치
- 페이지 상단 또는 폼 상단에 배지 형태로 표시

#### 2.2 표시 내용
- 무료 회원: "남은 무료 분석: X/3회"
- Pro 회원: "남은 분석: X/10회"
- 횟수 부족 시: "분석 횟수가 부족합니다" (빨간색)

#### 2.3 횟수 부족 처리
- 횟수가 0인 경우 폼 비활성화
- Pro 구독 유도 모달 표시
  - 제목: "분석 가능 횟수가 부족합니다"
  - 내용: "Pro 구독 시 월 10회 프리미엄 분석을 이용하실 수 있습니다"
  - 버튼: "Pro 구독하러 가기" → `/subscription` 페이지로 이동

### 3. Gemini API 호출 및 처리

#### 3.1 분석 요청 프로세스
1. "분석 시작" 버튼 클릭
2. Frontend 유효성 최종 검증
3. POST `/api/analyses/new` API 호출
   ```json
   {
     "subject_name": "홍길동",
     "birth_date": "1990-01-15",
     "birth_time": "14:30",  // optional
     "gender": "male"
   }
   ```
4. 로딩 상태 표시 (전체 페이지 오버레이)
5. 백엔드에서 Gemini API 호출
   - 무료 회원: `gemini-2.0-flash`
   - Pro 회원: `gemini-2.0-pro`
6. 분석 결과 저장 (Supabase `analyses` 테이블)
7. 분석 횟수 차감

#### 3.2 API 응답 처리
**성공 응답 (200 OK):**
```json
{
  "success": true,
  "data": {
    "analysis_id": "uuid",
    "status": "completed",
    "remaining_count": 2
  }
}
```
- `/analysis/{analysis_id}` 페이지로 자동 리다이렉트
- 리다이렉트 전 "분석이 완료되었습니다" 토스트 메시지 표시

**에러 응답:**
- **400 Bad Request** (분석 횟수 부족):
  - Pro 구독 유도 모달 표시
  - 에러 코드: `INSUFFICIENT_ANALYSIS_COUNT`

- **400 Bad Request** (유효성 검증 실패):
  - 에러 필드에 에러 메시지 표시
  - 에러 코드: `VALIDATION_ERROR`

- **409 Conflict** (중복 요청):
  - "이미 진행 중인 분석이 있습니다" 알림
  - 진행 중인 분석 페이지로 이동 유도

- **500 Internal Server Error** (Gemini API 실패):
  - "분석 처리 중 오류가 발생했습니다" 에러 메시지
  - "다시 시도" 버튼 표시
  - 차감된 분석 횟수는 자동 복구됨

### 4. 로딩 상태 표시

#### 4.1 로딩 오버레이
- 분석 요청 중 전체 페이지 오버레이 표시
- 스피너 애니메이션
- 진행 메시지: "AI가 사주를 분석하고 있습니다..."
- 예상 소요 시간 표시: "약 5-15초 소요됩니다"

#### 4.2 로딩 중 인터랙션
- 폼 입력 비활성화
- 뒤로가기 버튼 비활성화
- 브라우저 새로고침 방지 경고
  ```javascript
  window.onbeforeunload = () => "분석이 진행 중입니다. 페이지를 나가시겠습니까?";
  ```

#### 4.3 타임아웃 처리 (30초)
- 30초 이상 소요 시:
  - 메시지 변경: "분석이 예상보다 오래 걸리고 있습니다"
  - "대시보드로 돌아가기" 버튼 표시
  - 백그라운드에서 분석 계속 진행
  - 분석 완료 시 이메일/앱 내 알림 발송

### 5. 엣지케이스 처리

#### 5.1 중복 요청 방지
- 분석 시작 버튼 클릭 시 즉시 버튼 비활성화
- 이미 진행 중인 분석이 있는지 백엔드에서 확인
- 진행 중인 분석이 있으면 해당 분석 페이지로 이동

#### 5.2 네트워크 오류
- 3회 자동 재시도 (exponential backoff: 1s, 2s, 4s)
- 최종 실패 시 "네트워크 오류가 발생했습니다" 메시지
- "다시 시도" 버튼 제공

#### 5.3 세션 만료
- API 호출 시 401 Unauthorized 응답
- 자동으로 로그인 페이지로 리다이렉트
- 로그인 후 입력 정보 복원 (localStorage 활용)

#### 5.4 부적절한 입력 (욕설/비속어)
- 백엔드에서 간단한 필터링 수행
- 감지 시 400 Bad Request + 에러 코드 `INAPPROPRIATE_INPUT`
- 에러 메시지: "적절한 이름을 입력해주세요"

#### 5.5 데이터베이스 오류
- 백엔드에서 트랜잭션 롤백
- 500 Internal Server Error 응답
- 프론트엔드: "일시적 오류가 발생했습니다. 잠시 후 다시 시도해주세요"

## 데이터 흐름

### 1. 페이지 진입
```
User → /analysis/new
→ Frontend: 사용자 인증 확인 (Clerk)
→ Backend API: GET /api/user/analysis-count
→ Frontend: 남은 횟수 표시
```

### 2. 분석 요청
```
User: 폼 입력 + "분석 시작" 클릭
→ Frontend: 유효성 검증
→ Backend API: POST /api/analyses/new
→ Backend: Supabase에 분석 레코드 생성 (status: 'processing')
→ Backend: Gemini API 호출
→ Backend: 분석 결과 저장 (status: 'completed')
→ Backend: 사용자 분석 횟수 차감
→ Frontend: 결과 페이지로 리다이렉트
```

### 3. 에러 발생
```
Backend API 에러
→ Frontend: 에러 타입 판단
→ 횟수 부족: Pro 구독 유도 모달
→ Gemini API 실패: 횟수 복구 + 재시도 버튼
→ 네트워크 오류: 자동 재시도 후 수동 재시도 버튼
```

## 데이터베이스 사용

### 1. analyses 테이블
- 분석 요청 시 새 레코드 INSERT
- 초기 `status = 'processing'`
- Gemini API 성공 시 `status = 'completed'` 업데이트
- 실패 시 `status = 'failed'` 업데이트

### 2. users 테이블
- 분석 횟수 차감 (트랜잭션)
  - 무료 회원: `free_analysis_count = free_analysis_count - 1`
  - Pro 회원: `monthly_analysis_count = monthly_analysis_count - 1`
- 분석 실패 시 횟수 복구 (+1)

## UI/UX 고려사항

### 1. 접근성
- 모든 입력 필드에 `label` 명시
- 에러 메시지는 `aria-live="polite"`로 스크린 리더 지원
- 키보드 네비게이션 지원 (Tab, Enter)

### 2. 반응형 디자인
- 모바일: 세로 스택 레이아웃
- 태블릿/데스크톱: 2컬럼 레이아웃
- 날짜 선택기는 모바일에서 네이티브 picker 사용

### 3. 사용자 피드백
- 입력 시 실시간 유효성 검증 피드백
- 로딩 중 명확한 진행 상태 표시
- 성공/실패 시 토스트 메시지로 결과 안내

### 4. 성능 최적화
- 입력 필드 debounce (300ms)로 과도한 검증 방지
- Gemini API 타임아웃 30초로 설정
- 폼 입력값 localStorage에 임시 저장 (세션 만료 대비)

## 비즈니스 룰

### 1. 분석 횟수 정책
- 무료 회원: 가입 시 3회 제공, 소진 후 추가 불가
- Pro 회원: 월 10회, 매월 1일 00:00(KST) 자동 초기화
- 분석 실패 시 차감된 횟수는 자동 복구

### 2. AI 모델 선택
- 무료 회원: `gemini-2.0-flash` (빠른 응답, 기본 정확도)
- Pro 회원: `gemini-2.0-pro` (높은 정확도, 상세 분석)
- 구독 등급은 분석 요청 시점 기준으로 판단

### 3. Rate Limiting
- 동일 사용자 분당 최대 5회 요청 제한
- 초과 시 429 Too Many Requests 응답
- 에러 메시지: "요청이 너무 많습니다. 잠시 후 다시 시도해주세요"

### 4. 데이터 보관
- 모든 분석 요청은 `analyses` 테이블에 기록됨
- 분석 결과는 영구 보관 (사용자 탈퇴 시 CASCADE 삭제)
- 분석 실패 건도 로그로 보관 (모니터링 용도)

## 보안 고려사항

### 1. 인증 및 인가
- 모든 API 요청에 Clerk JWT 토큰 포함
- 백엔드에서 토큰 검증 및 user_id 추출
- 사용자는 본인의 분석만 생성 가능

### 2. 입력값 검증
- Frontend: 기본 유효성 검증
- Backend: Zod 스키마로 엄격한 검증
- SQL Injection 방지: Prepared Statements 사용

### 3. Rate Limiting
- 애플리케이션 레벨에서 사용자별 요청 횟수 제한
- Redis 또는 Supabase 기반 Rate Limiter 구현

## 모니터링 지표

### 1. 성능 지표
- 평균 분석 소요 시간: 목표 5-15초
- Gemini API 응답 시간 로깅
- 페이지 로딩 시간

### 2. 비즈니스 지표
- 일일 분석 요청 수
- 무료 회원 vs Pro 회원 비율
- Pro 전환율 (분석 횟수 소진 후)

### 3. 품질 지표
- 분석 성공률: 목표 95% 이상
- 분석 실패율 및 실패 원인 분석
- 사용자 이탈률 (폼 작성 중 이탈)

## 향후 확장 고려사항

### 1. 배치 분석
- 여러 사람의 정보를 한 번에 입력하여 분석
- CSV 파일 업로드 기능

### 2. 분석 템플릿
- 자주 분석하는 대상 정보를 템플릿으로 저장
- 빠른 재분석 기능

### 3. AI 모델 선택
- Pro 회원이 모델을 직접 선택할 수 있도록 옵션 제공
- 모델별 예상 소요 시간 및 정확도 안내

### 4. 분석 커스터마이징
- 특정 영역(재운, 건강운 등)에 집중한 분석 옵션
- 상세도 레벨 선택 (간단/보통/상세)
