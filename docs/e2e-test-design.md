# E2E 테스트 설계 문서

## 개요

사주풀이 서비스의 핵심 유저플로우에 대한 E2E 테스트를 TDD 방식으로 설계하고 구현합니다.

## 테스트 환경

- **테스트 프레임워크**: Playwright
- **로컬 URL**: http://localhost:3000
- **프로덕션 URL**: https://vmc5-2.vercel.app/
- **테스트 계정**: cooledricesh@gmail.com (Clerk Google OAuth)

## 테스트 시나리오

### 1. 로그인 플로우

#### 시나리오 1-1: Google OAuth를 통한 로그인 성공

**Given (준비)**
- 사용자가 로그아웃 상태
- 홈페이지에 접근

**When (실행)**
- "로그인" 버튼 클릭
- Clerk 로그인 화면에서 "Continue with Google" 선택
- cooledricesh@gmail.com 계정 선택 및 인증

**Then (검증)**
- 대시보드 페이지로 리다이렉트 (/dashboard)
- 환영 메시지 표시
- 사용자 프로필 정보 표시 (이메일 또는 이름)
- 구독 상태 표시 (무료/Pro)
- 잔여 분석 횟수 표시

**검증 포인트**
- [ ] URL이 /dashboard로 변경
- [ ] 페이지 로딩 완료 (networkidle)
- [ ] 사용자 정보 섹션 존재
- [ ] "새 분석하기" 버튼 표시
- [ ] 401/403 에러 없음

#### 시나리오 1-2: 로그인 실패 처리

**Given (준비)**
- 사용자가 로그아웃 상태
- 잘못된 인증 정보

**When (실행)**
- 로그인 시도
- 인증 실패

**Then (검증)**
- 에러 메시지 표시
- 로그인 페이지 유지
- 재시도 가능

---

### 2. 사주 분석 의뢰 플로우

#### 시나리오 2-1: 새 사주 분석 요청 성공

**Given (준비)**
- 사용자가 로그인 상태
- 대시보드에 위치
- 분석 잔여 횟수 1회 이상

**When (실행)**
- "새 분석하기" 버튼 클릭
- 분석 정보 입력:
  - 성함: "홍길동"
  - 생년월일: "1990-01-01"
  - 출생시간: "10:30" (선택)
  - 성별: "남"
- "분석 시작" 버튼 클릭

**Then (검증)**
- 로딩 상태 표시
- 분석 처리 중 메시지 표시
- 분석 완료 후 상세 페이지로 이동 (/analysis/[id])
- 분석 결과 표시 시작
- 잔여 횟수 1 감소

**검증 포인트**
- [ ] 입력 폼 모든 필드 입력 가능
- [ ] 유효성 검증 동작 (필수 필드 체크)
- [ ] 로딩 스피너 표시
- [ ] API 호출 성공 (network 탭 확인)
- [ ] URL 변경 (/analysis/[id])
- [ ] 분석 결과 렌더링 시작

#### 시나리오 2-2: 필수 필드 미입력 시 유효성 검증

**Given (준비)**
- 사용자가 새 분석 페이지에 위치

**When (실행)**
- 필수 필드 일부만 입력
- "분석 시작" 버튼 클릭

**Then (검증)**
- 유효성 검증 에러 메시지 표시
- 폼 제출 실패
- 페이지 유지

**검증 포인트**
- [ ] 성함 미입력 시 에러 메시지
- [ ] 생년월일 미입력 시 에러 메시지
- [ ] 성별 미선택 시 에러 메시지
- [ ] 에러 필드로 포커스 이동

#### 시나리오 2-3: 분석 횟수 부족 시 처리

**Given (준비)**
- 사용자가 로그인 상태
- 무료 회원이며 잔여 횟수 0회

**When (실행)**
- "새 분석하기" 버튼 클릭 또는 폼 제출

**Then (검증)**
- Pro 구독 유도 모달 표시
- "Pro 구독하기" 버튼 표시
- 분석 진행 차단

**검증 포인트**
- [ ] 모달 팝업 표시
- [ ] Pro 혜택 안내 표시
- [ ] 구독 페이지로 이동 가능
- [ ] 모달 닫기 가능

---

### 3. 분석 결과 확인 플로우

#### 시나리오 3-1: 분석 결과 상세 조회

**Given (준비)**
- 사용자가 로그인 상태
- 완료된 분석 건이 존재

**When (실행)**
- 대시보드에서 분석 카드 클릭
- 또는 분석 완료 후 자동 이동

**Then (검증)**
- 분석 상세 페이지 로드 (/analysis/[id])
- 기본 정보 표시:
  - 성함
  - 생년월일
  - 출생시간 (입력한 경우)
  - 성별
  - 분석 일시
- 분석 결과 섹션 표시:
  - 천간지지 계산 결과
  - 오행 분포도
  - 대운/세운 흐름
  - 종합 해석
- 탭 네비게이션 동작
- 액션 버튼 표시 (다운로드, 공유 등)

**검증 포인트**
- [ ] 페이지 정상 로드 (200 OK)
- [ ] 기본 정보 모든 필드 표시
- [ ] 분석 결과 마크다운 렌더링
- [ ] 차트 렌더링 (오행 분포도 등)
- [ ] 탭 전환 동작
- [ ] 401/403 에러 없음

#### 시나리오 3-2: 타인의 분석 결과 접근 차단

**Given (준비)**
- 사용자 A가 로그인 상태
- 사용자 B의 분석 ID를 직접 URL로 접근

**When (실행)**
- /analysis/[user_b_analysis_id] 접근 시도

**Then (검증)**
- 403 Forbidden 에러 또는 리다이렉트
- 에러 메시지 표시
- 대시보드로 리다이렉트

**검증 포인트**
- [ ] 권한 검증 동작
- [ ] 적절한 에러 메시지
- [ ] 자동 리다이렉트

#### 시나리오 3-3: 처리 중인 분석 조회

**Given (준비)**
- 사용자가 분석 요청 제출
- 분석이 아직 처리 중 (status: processing)

**When (실행)**
- 분석 상세 페이지 접근

**Then (검증)**
- 로딩 상태 표시
- "분석 중" 메시지 표시
- 자동 새로고침 또는 폴링
- 완료 시 결과 자동 표시

**검증 포인트**
- [ ] 로딩 스피너 표시
- [ ] 진행 상태 메시지
- [ ] 자동 갱신 동작
- [ ] 완료 시 결과 렌더링

---

## 엣지케이스 테스트

### 4-1: 네트워크 오류 처리

**Given**: 불안정한 네트워크 환경
**When**: API 호출 실패
**Then**: 적절한 에러 메시지 및 재시도 옵션

### 4-2: 세션 만료 처리

**Given**: 로그인 상태에서 세션 만료
**When**: 인증 필요한 작업 시도
**Then**: 자동 로그아웃 및 재로그인 유도

### 4-3: API 타임아웃

**Given**: 분석 처리 중
**When**: 30초 이상 소요
**Then**: 타임아웃 처리 및 백그라운드 처리 안내

### 4-4: 중복 요청 방지

**Given**: 분석 진행 중
**When**: 동일 요청 재시도
**Then**: 중복 요청 차단 및 안내 메시지

---

## 테스트 헬퍼 함수

### 인증 헬퍼
```typescript
async function loginWithGoogle(page: Page, email: string)
async function logout(page: Page)
async function ensureAuthenticated(page: Page)
```

### 분석 헬퍼
```typescript
async function createNewAnalysis(page: Page, data: AnalysisData)
async function waitForAnalysisComplete(page: Page, analysisId: string)
async function navigateToAnalysis(page: Page, analysisId: string)
```

### 검증 헬퍼
```typescript
async function assertDashboardLoaded(page: Page)
async function assertAnalysisFormVisible(page: Page)
async function assertAnalysisResultVisible(page: Page)
async function assertErrorMessage(page: Page, message: string)
```

---

## 테스트 실행 전략

### 테스트 순서
1. 로그인 플로우 (선행 조건)
2. 사주 분석 의뢰 플로우
3. 분석 결과 확인 플로우
4. 엣지케이스

### 테스트 격리
- 각 테스트는 독립적으로 실행 가능
- beforeEach에서 초기 상태 설정
- afterEach에서 정리 작업

### 테스트 데이터
- 고정된 테스트 계정 사용 (cooledricesh@gmail.com)
- 분석 데이터는 매 테스트마다 고유값 생성
- 테스트 완료 후 생성된 데이터 정리 (선택)

---

## 성공 기준

- [ ] 모든 핵심 플로우 테스트 통과
- [ ] 엣지케이스 처리 검증
- [ ] 테스트 커버리지 80% 이상 (핵심 플로우)
- [ ] CI/CD 파이프라인 통합
- [ ] 테스트 실행 시간 5분 이내

---

## 제약사항 및 고려사항

### Clerk OAuth 인증
- Playwright에서 Google OAuth 자동화는 복잡함
- 대안:
  1. Clerk의 테스트 모드 활용
  2. 세션 토큰 직접 주입
  3. 인증 우회 모드 (개발 환경)

### Gemini API
- 실제 API 호출 시 비용 발생
- 테스트 환경에서는 모킹 또는 스텁 사용 권장
- E2E 테스트에서는 제한적으로 실제 API 호출

### 비동기 처리
- 분석 완료까지 시간 소요 (10-30초)
- 적절한 대기 시간 설정
- 폴링 또는 WebSocket 활용

---

## 다음 단계

1. 테스트 헬퍼 함수 구현
2. 인증 플로우 테스트 작성 (RED)
3. 최소 구현 (GREEN)
4. 리팩토링
5. 다음 플로우 반복
