# 📝 대시보드 API 404 에러 수정 요청

## 🔴 문제 상황 / 요구사항

### 현재 문제 상황
- **증상**: 대시보드 페이지 접근 시 API 엔드포인트들이 404 에러 반환
- **재현 경로**:
  1. Clerk로 로그인 성공
  2. /dashboard 페이지 접근
  3. 콘솔에 404 에러 다수 발생
- **에러 메시지**:
  ```
  Failed to load resource: the server responded with a status of 404 (Not Found)
  - api/dashboard/stats:1
  - api/dashboard/summary:1
  - api/analyses?period=all&sort=latest&page=1&limit=10:1
  ```
- **예상 원인**:
  - API 라우트 등록 문제
  - 인증 미들웨어 충돌
  - Hono 라우터와 Next.js 통합 이슈
- **영향 범위**: 대시보드 전체 기능 사용 불가

### 기대 동작
- 인증된 사용자가 대시보드에 접근하면 모든 API가 정상 응답
- 통계 정보, 사용자 요약, 분석 목록이 정상적으로 로드

## 🧪 TDD 방식으로 해결해주세요

### 📍 1단계: RED - 실패하는 테스트 먼저 작성

#### 1.1 통합/E2E 테스트 작성
```
위치: tests-e2e/dashboard-api.spec.ts
- [ ] 대시보드 페이지 전체 플로우 테스트
- [ ] API 엔드포인트 접근성 테스트
- [ ] 인증 상태에 따른 응답 테스트
```

#### 1.2 단위 테스트 작성
```
위치: src/features/dashboard/__tests__/
- [ ] route.test.ts - API 라우트 등록 테스트
- [ ] service.test.ts - 비즈니스 로직 테스트
- [ ] middleware-integration.test.ts - 인증 미들웨어 통합 테스트
```

#### 1.3 API/라우팅 테스트 작성
```
위치: src/backend/__tests__/hono-app.test.ts
- [ ] /api/dashboard/summary 엔드포인트 존재 여부
- [ ] /api/dashboard/stats 엔드포인트 존재 여부
- [ ] /api/analyses 엔드포인트 존재 여부
- [ ] 인증 헤더 처리 테스트
```

**⚠️ 중요: 테스트 실행하여 404 에러 재현 확인**

### ✅ 2단계: GREEN - 테스트 통과하는 최소 코드 구현

#### 2.1 핵심 기능 구현
- [ ] Hono 라우터 등록 확인 및 수정
- [ ] 인증 미들웨어 충돌 해결 (clerkAuthMiddleware vs withClerkAuth)
- [ ] Context에서 userId 올바르게 전달

#### 2.2 단계별 검증
- 각 엔드포인트별 테스트 실행
- 인증 있는/없는 요청 테스트
- 실제 API 호출 테스트

### 🔧 3단계: REFACTOR - 코드 개선

#### 3.1 코드 품질 개선
- [ ] 중복된 인증 미들웨어 제거
- [ ] getUserId 헬퍼 함수 통일
- [ ] 에러 응답 표준화

#### 3.2 성능 및 안정성
- [ ] 적절한 에러 메시지 반환
- [ ] 로깅 추가
- [ ] TypeScript 타입 개선

## 📋 구현 요구사항

### 기능 요구사항
- **필수 기능 1**: /api/dashboard/summary가 사용자 정보 반환
- **필수 기능 2**: /api/dashboard/stats가 통계 정보 반환
- **필수 기능 3**: /api/analyses가 분석 목록 반환
- **필수 기능 4**: 모든 API는 Clerk 인증 필요

### 비기능 요구사항
- **성능**: API 응답 시간 < 500ms
- **보안**: 인증되지 않은 접근 차단 (401 반환)
- **확장성**: 향후 다른 대시보드 API 추가 용이
- **유지보수성**: 명확한 라우팅 구조

## 🎯 테스트 커버리지

### 정상 케이스 (Happy Path)
- [ ] 인증된 사용자 → API 호출 → 200 OK 응답
- [ ] 올바른 데이터 형식 반환

### 엣지 케이스
- [ ] 빈 데이터 처리
- [ ] 페이지네이션 경계값
- [ ] 동시 다중 요청

### 에러 케이스
- [ ] 인증 없는 요청 → 401 반환
- [ ] 잘못된 파라미터 → 400 반환
- [ ] DB 연결 실패 → 500 반환
- [ ] 존재하지 않는 라우트 → 404 반환

## ✔️ 완료 조건 (Definition of Done)

### 테스트
- [ ] 모든 API 엔드포인트 테스트 작성
- [ ] 모든 테스트 통과 (새 테스트 + 기존 auth 테스트)
- [ ] 404 에러가 더 이상 발생하지 않음

### 코드 품질
- [ ] TypeScript 타입 에러 없음
- [ ] ESLint 경고 없음
- [ ] 빌드 성공

### 검증
- [ ] 브라우저에서 대시보드 정상 로드
- [ ] 네트워크 탭에서 모든 API 200 응답 확인
- [ ] 콘솔에 에러 없음

## 📌 참고사항

### 현재 상황 분석
- Clerk-Supabase 동기화는 성공적으로 완료됨
- 사용자는 정상적으로 DB에 저장됨
- 하지만 API 라우트가 404를 반환하는 새로운 문제

### 테스트 범위 구분
- 이전 테스트: 인증 및 사용자 동기화 (✅ 완료)
- 현재 테스트: API 라우팅 및 엔드포인트 (❌ 새로 필요)

### 디버깅 팁
```javascript
// 404 에러는 라우팅 문제
// 401 에러는 인증 문제
// 500 에러는 서버 로직 문제
```