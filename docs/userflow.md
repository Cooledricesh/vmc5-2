# 유저플로우 문서

## 1. 인증 및 계정 관리

### 1.1 회원가입

#### 입력
- 홈 페이지에서 "회원가입" 버튼 클릭
- Clerk 로그인 화면에서 "Google로 계속하기" 선택
- Google 계정 선택 및 권한 승인

#### 처리
1. Google OAuth 토큰 검증 (Clerk)
2. 사용자 정보 추출 (이메일, 이름, 프로필 이미지)
3. Clerk Webhook 트리거
4. 데이터베이스에 신규 사용자 생성
   - user_id (Clerk ID)
   - email
   - name
   - profile_image
   - subscription_status = 'free'
   - analysis_count = 3 (무료 체험 횟수)
   - created_at = 현재 시각
5. 세션 생성 및 JWT 토큰 발급

#### 출력
- 회원가입 성공 시 대시보드로 리다이렉트
- 환영 메시지 표시
- 무료 체험 3회 안내 토스트 표시

#### 엣지케이스
- Google OAuth 실패: 에러 메시지 표시 후 재시도 유도
- 이미 가입된 이메일: 자동 로그인 처리
- Webhook 실패: 재시도 큐에 추가, 임시 세션으로 진행
- 데이터베이스 오류: 롤백 후 에러 페이지 표시

### 1.2 로그인

#### 입력
- 홈 페이지 또는 모든 페이지에서 "로그인" 버튼 클릭
- Clerk 로그인 화면에서 "Google로 계속하기" 선택
- Google 계정 선택

#### 처리
1. Google OAuth 토큰 검증 (Clerk)
2. Clerk ID로 사용자 조회
3. 사용자 정보 업데이트
   - last_login_at = 현재 시각
   - 프로필 정보 동기화 (필요시)
4. 구독 상태 확인
   - Pro 회원인 경우 만료일 체크
   - 만료된 경우 subscription_status = 'free'로 변경
5. 세션 생성 및 JWT 토큰 발급
6. 리다이렉트 URL 결정
   - 이전 페이지 URL 존재 시 해당 페이지
   - 없으면 대시보드

#### 출력
- 로그인 성공 시 대시보드 또는 이전 페이지로 리다이렉트
- 환영 메시지 표시 (이름 포함)
- 구독 상태에 따른 안내 (잔여 횟수 또는 Pro 혜택)

#### 엣지케이스
- Google OAuth 실패: 에러 메시지 표시 후 재시도
- 미가입 사용자: 자동 회원가입 프로세스 진행
- 탈퇴한 사용자: 재가입 안내 메시지
- 정지된 계정: 정지 사유 안내 및 지원 문의 유도
- 세션 만료: 자동 로그아웃 후 재로그인 요청

### 1.3 로그아웃

#### 입력
- 헤더 네비게이션의 프로필 드롭다운 클릭
- "로그아웃" 메뉴 선택
- 또는 세션 만료 시 자동 로그아웃

#### 처리
1. 로그아웃 요청 확인
   - 현재 세션 정보 확인
   - 진행 중인 작업 체크 (분석 진행 중 등)
2. 세션 종료 처리
   - Clerk 로그아웃 API 호출
   - JWT 토큰 무효화
   - 로컬 스토리지 클리어
   - 쿠키 삭제
3. 사용자 활동 로그 기록
   - logout_at = 현재 시각
   - session_duration 계산
4. 임시 데이터 정리
   - 미완성 분석 요청 취소
   - 캐시 데이터 클리어

#### 출력
- 홈 페이지(랜딩페이지)로 리다이렉트
- "안전하게 로그아웃되었습니다" 토스트 메시지
- 로그인 버튼 표시

#### 엣지케이스
- 네트워크 오류: 로컬 로그아웃 후 서버 동기화 재시도
- 진행 중인 분석: 저장 여부 확인 모달
- 다중 탭 열림: 모든 탭에서 동시 로그아웃
- 자동 로그아웃: 세션 만료 안내 메시지

## 2. 사주 분석 서비스

### 2.1 새 사주 분석하기

#### 입력
- 대시보드에서 "새 분석하기" 버튼 클릭
- 분석 정보 입력
  - 성함 (텍스트 입력)
  - 생년월일 (날짜 선택기)
  - 출생시간 (시/분 드롭다운, 선택사항)
  - 성별 (라디오 버튼: 남/여)
- "분석 시작" 버튼 클릭

#### 처리
1. 입력값 유효성 검증
   - 필수 필드 확인
   - 생년월일 유효성 (미래 날짜 불가)
   - 성함 길이 제한 (2-50자)
2. 사용자 분석 가능 횟수 확인
   - 무료 회원: analysis_count > 0
   - Pro 회원: monthly_analysis_count > 0
3. 분석 요청 생성
   - analysis_id 생성
   - status = 'processing'
   - 입력 정보 저장
4. Gemini API 호출
   - 무료: gemini-2.0-flash
   - Pro: gemini-2.0-pro
   - 프롬프트 생성 및 전송
5. AI 응답 처리
   - 마크다운 파싱
   - 데이터베이스 저장
   - status = 'completed'
6. 분석 횟수 차감
   - 무료: analysis_count - 1
   - Pro: monthly_analysis_count - 1

#### 출력
- 처리 중: 로딩 애니메이션 및 진행 상태 표시
- 완료 시: 분석 상세 페이지로 자동 이동
- 분석 결과 표시 (천간지지, 오행, 운세 등)

#### 엣지케이스
- 분석 횟수 부족: Pro 구독 유도 모달 표시
- Gemini API 오류: 재시도 (최대 3회), 실패 시 환불/보상
- 타임아웃 (30초): 백그라운드 처리 후 알림
- 중복 요청: 진행 중인 분석 있으면 차단
- 부적절한 입력: 욕설/비속어 필터링

### 2.2 분석 결과 조회

#### 입력
- 대시보드의 분석 목록에서 특정 분석 카드 클릭
- 또는 분석 완료 후 자동 리다이렉트
- 또는 직접 URL 접근 (/analysis/[id])

#### 처리
1. 분석 ID 및 사용자 권한 확인
   - analysis.user_id === current_user.id
   - 타인의 분석 결과 접근 차단
2. 분석 데이터 조회
   - 기본 정보 (성함, 생년월일, 성별, 출생시간)
   - 분석 일시
   - AI 모델 종류 (flash/pro)
3. 분석 결과 파싱
   - 천간지지 데이터
   - 오행 분포 데이터
   - 대운/세운 데이터
   - 종합 해석 (성격, 재운, 건강운, 연애운)
4. 마크다운 렌더링 처리
   - 섹션별 구조화
   - 차트 데이터 변환
5. 조회수 업데이트
   - view_count + 1
   - last_viewed_at = 현재 시각

#### 출력
- 분석 상세 페이지 표시
  - 탭 구조 (개요/오행분석/운세흐름/종합해석)
  - 시각화 차트 (오행 분포도, 대운 그래프)
  - 마크다운 렌더링된 상세 해석
- 액션 버튼
  - PDF 다운로드
  - 공유하기 (카카오톡, URL 복사)
  - 재분석 요청

#### 엣지케이스
- 삭제된 분석: 404 에러 페이지
- 권한 없음: 403 에러, 대시보드로 리다이렉트
- 처리 중인 분석: 로딩 상태 표시, 자동 새로고침
- 분석 실패 건: 에러 상태 표시, 재분석 유도
- 마크다운 파싱 오류: 원본 텍스트 표시

### 2.3 분석 이력 조회 (대시보드)

#### 입력
- 로그인 후 자동 리다이렉트 또는 네비게이션에서 "대시보드" 클릭
- 필터/정렬 옵션 선택 (선택사항)
  - 기간 필터 (전체/최근 7일/30일/90일)
  - 정렬 (최신순/오래된순)
  - 페이지네이션 (10개씩)

#### 처리
1. 사용자 인증 상태 확인
   - 로그인 여부
   - user_id 추출
2. 사용자 정보 조회
   - 구독 상태 (free/pro)
   - 남은 분석 횟수
   - 다음 결제일 (Pro인 경우)
3. 분석 이력 조회
   - user_id로 분석 목록 쿼리
   - 필터 조건 적용
   - 정렬 조건 적용
   - 페이지네이션 처리
4. 통계 데이터 계산
   - 총 분석 횟수
   - 이번 달 분석 횟수
   - 자주 분석한 시간대
5. 각 분석 카드 데이터 준비
   - 분석 대상 이름
   - 분석 일시
   - AI 모델 종류
   - 미리보기 텍스트 (첫 100자)

#### 출력
- 상단 요약 섹션
  - 환영 메시지
  - 구독 상태 뱃지
  - 남은 횟수 표시 (무료: X/3, Pro: X/10)
  - 새 분석하기 CTA 버튼
- 분석 목록 그리드/리스트
  - 분석 카드 (클릭 가능)
  - 분석 일시
  - 간단한 요약
- 빈 상태 (분석 이력 없음)
  - 첫 분석 유도 메시지
  - 새 분석하기 버튼

#### 엣지케이스
- 로그인 만료: 로그인 페이지로 리다이렉트
- 대량 데이터: 무한 스크롤 또는 페이지네이션
- 삭제된 분석: 목록에서 제외
- 처리 중인 분석: "분석 중" 상태 표시
- 네트워크 오류: 재시도 버튼 표시

## 3. 구독 및 결제 관리

### 3.1 Pro 구독 신청

#### 입력
- 구독 관리 페이지 접속 또는 분석 횟수 소진 시 구독 유도 모달
- "Pro 구독 시작" 버튼 클릭
- 토스페이먼츠 결제창에서 카드 정보 입력
  - 카드번호
  - 유효기간
  - CVC
  - 카드 소유자명
- 약관 동의 체크박스
- "결제하기" 버튼 클릭

#### 처리
1. 결제 정보 유효성 검증 (토스페이먼츠)
2. 빌링키 발급 요청
   - customer_key = user_id
   - 카드 정보 토큰화
3. 초회 결제 실행
   - amount = 9,900원 (예시)
   - order_id 생성
4. 결제 성공 시 구독 정보 생성
   - subscription_id
   - billing_key
   - subscription_status = 'active'
   - next_payment_date = 오늘 + 1개월
   - price = 9,900
5. 사용자 정보 업데이트
   - subscription_tier = 'pro'
   - monthly_analysis_count = 10
6. 결제 내역 저장
   - payment_id
   - payment_status = 'completed'
   - payment_method (카드 마지막 4자리)

#### 출력
- 결제 성공: 구독 완료 페이지로 이동
- Pro 혜택 안내 메시지
- 첫 결제 영수증 이메일 발송
- 다음 결제일 안내

#### 엣지케이스
- 카드 한도 초과: 다른 결제수단 안내
- 3D Secure 인증 실패: 재시도 요청
- 빌링키 발급 실패: 카드사 문의 안내
- 중복 구독 시도: 이미 구독 중 알림
- 네트워크 오류: 결제 상태 확인 후 처리
- 프로모션 코드: 할인 적용 로직

### 3.2 Pro 구독 해지

#### 입력
- 구독 관리 페이지 접속
- "구독 해지" 버튼 클릭
- 해지 사유 선택 (선택사항)
  - 가격이 비싸요
  - 사용 빈도가 낮아요
  - 서비스가 만족스럽지 않아요
  - 기타 (직접 입력)
- "구독 해지 확인" 버튼 클릭
- 최종 확인 모달에서 "해지하기" 클릭

#### 처리
1. 현재 구독 상태 확인
   - subscription_status = 'active' 확인
   - next_payment_date 조회
2. 구독 해지 처리
   - subscription_status = 'pending_cancellation'
   - cancelled_at = 현재 시각
   - cancellation_reason = 선택한 사유
3. 토스페이먼츠 빌링키 삭제
   - billing_key로 삭제 요청
   - 삭제 확인 응답 대기
4. 빌링 정보 업데이트
   - billing_key = null
   - auto_renewal = false
5. 혜택 유지 기간 계산
   - effective_until = next_payment_date
   - 기간 동안 Pro 혜택 유지
6. 해지 확인 이메일 발송
   - 해지 일시
   - 혜택 종료일
   - 재활성화 안내

#### 출력
- 해지 완료 메시지
- 혜택 유지 기간 안내 (X일 남음)
- 재활성화 가능 기간 표시
- 대시보드로 리다이렉트

#### 엣지케이스
- 이미 해지된 구독: 중복 해지 방지 메시지
- 빌링키 삭제 실패: 수동 처리 안내, 고객지원 연결
- 환불 요청: 7일 이내 구독 시 전액 환불 처리
- 결제일 당일 해지: 다음 달부터 해지 적용 확인
- 재활성화 후 재해지: 횟수 제한 없이 허용

### 3.3 구독 재활성화

#### 입력
- 구독 관리 페이지 접속 (해지 후 결제일 이전)
- "구독 재활성화" 버튼 표시
- 버튼 클릭
- 재활성화 확인 모달에서 "확인" 클릭

#### 처리
1. 재활성화 가능 여부 확인
   - subscription_status = 'pending_cancellation'
   - effective_until > 현재 시각 (아직 혜택 기간 내)
   - 이전 billing_key 존재 여부
2. 빌링키 복구 또는 재등록
   - 이전 빌링키 유효성 확인
   - 유효하지 않으면 새 카드 등록 프로세스
3. 구독 정보 업데이트
   - subscription_status = 'active'
   - auto_renewal = true
   - cancelled_at = null
   - 기존 next_payment_date 유지
4. 결제 스케줄 복구
   - 정기결제 큐에 재등록
   - 다음 결제일 확인
5. 재활성화 확인 이메일 발송
   - 재활성화 일시
   - 다음 결제 예정일
   - 월 이용 가능 횟수

#### 출력
- 재활성화 성공 메시지
- Pro 혜택 안내
- 구독 관리 페이지 새로고침
- 상태 뱃지 'Active'로 변경

#### 엣지케이스
- 혜택 기간 만료 후 시도: 신규 구독으로 안내
- 카드 유효성 실패: 새 카드 등록 요청
- 중복 재활성화: 이미 활성화됨 메시지
- 결제일 당일 재활성화: 즉시 결제 진행 확인
- 빈번한 해지/재활성화: 제한 없이 허용

### 3.4 결제 정보 변경 (카드 변경)

#### 입력
- 구독 관리 페이지에서 "결제 정보 변경" 버튼 클릭
- 토스페이먼츠 카드 변경 창 표시
- 새 카드 정보 입력
  - 카드번호
  - 유효기간
  - CVC
  - 카드 소유자명
- "카드 변경" 버튼 클릭

#### 처리
1. 현재 구독 상태 확인
   - subscription_status = 'active'
   - 기존 billing_key 조회
2. 새 카드 유효성 검증 (토스페이먼츠)
   - 카드 정보 검증
   - 3D Secure 인증 (필요시)
3. 새 빌링키 발급
   - customer_key = user_id
   - 새 카드로 빌링키 생성
4. 테스트 결제 (0원 또는 1원)
   - 카드 사용 가능 여부 확인
   - 즉시 취소 처리
5. 빌링 정보 업데이트
   - 기존 billing_key 삭제
   - 새 billing_key 저장
   - card_last_4digits 업데이트
   - card_type 저장 (신용/체크)
   - updated_at = 현재 시각
6. 변경 확인 이메일 발송
   - 변경 일시
   - 마스킹된 카드 정보
   - 다음 결제 예정일

#### 출력
- 카드 변경 성공 메시지
- 새 카드 정보 표시 (마지막 4자리)
- 구독 관리 페이지 새로고침

#### 엣지케이스
- 동일 카드 등록: 변경사항 없음 메시지
- 카드 한도 부족: 다른 카드 사용 권유
- 해외 카드: 지원 카드사 목록 안내
- 법인 카드: 사업자 확인 절차
- 빌링키 발급 실패: 카드사 문의 안내
- 체크카드 잔액 부족: 충전 후 재시도 안내

### 3.5 정기결제 자동 처리 (시스템 백그라운드)

#### 입력
- Supabase cron job 트리거 (매일 02:00)
- 또는 수동 트리거 (관리자)

#### 처리
1. 결제 대상 조회
   - subscription_status = 'active'
   - next_payment_date = 오늘
   - billing_key IS NOT NULL
2. 각 구독자별 결제 처리 (배치)
   - 토스페이먼츠 빌링키로 결제 요청
   - amount = subscription.price
   - order_id 생성
3. 결제 성공 시
   - payment_status = 'completed'
   - payment_id 저장
   - next_payment_date = 오늘 + 1개월
   - monthly_analysis_count = 10 (리셋)
   - 결제 성공 이메일 발송
4. 결제 실패 시
   - payment_status = 'failed'
   - retry_count + 1
   - 재시도 스케줄링 (1일 후, 최대 3회)
5. 최종 실패 처리
   - retry_count >= 3인 경우
   - subscription_status = 'suspended'
   - billing_key 삭제
   - subscription_tier = 'free'
   - 구독 해지 안내 이메일

#### 출력
- 결제 성공: 영수증 이메일, 앱 내 알림
- 결제 실패: 카드 정보 업데이트 요청 이메일
- 최종 해지: 구독 해지 안내 및 재가입 유도

#### 엣지케이스
- Cron job 실패: 모니터링 알람, 수동 실행
- 대량 결제 실패: 일시적 서비스 장애 체크
- 중복 결제: 결제 ID로 중복 방지
- 환율 변동: 고정 KRW 금액 유지
- 부분 결제: 전액 결제만 허용

## 4. 공통 엣지케이스 처리

### 4.1 네트워크 오류
- 모든 API 호출에 retry 로직 적용 (최대 3회)
- 오프라인 상태 감지 및 사용자 알림
- 요청 큐잉 및 온라인 복귀 시 자동 처리

### 4.2 인증 오류
- 토큰 만료: 자동 갱신 시도
- 갱신 실패: 재로그인 유도
- 권한 부족: 적절한 권한 안내 메시지

### 4.3 데이터 일관성
- 트랜잭션 처리로 원자성 보장
- 낙관적 업데이트 후 실패 시 롤백
- 충돌 감지 및 병합 전략

### 4.4 성능 최적화
- 페이지네이션 및 무한 스크롤
- 이미지 lazy loading
- API 응답 캐싱 (5분)
- 디바운싱 및 스로틀링

## 5. 보안 고려사항

### 5.1 인증 및 인가
- JWT 토큰 기반 인증
- HTTPS 강제 적용
- CORS 정책 설정
- Rate limiting

### 5.2 데이터 보호
- 개인정보 암호화 저장
- 결제 정보 토큰화 (PCI DSS 준수)
- SQL injection 방지
- XSS 방지

### 5.3 감사 로그
- 모든 중요 작업 로깅
- 결제 이벤트 추적
- 보안 이벤트 모니터링
- 정기 보안 감사